#!/bin/bash

if [ $# -lt 3 ]; then
  echo "usage: $0 <srcNamenode> <dstNamenode> <srcDir> [mapNum] [bandWidth]"
  exit 1
fi

srcNamenode=$1
dstNamenode=$2
srcDir=$3
dstDir=/
mapTaskNum=25
bandWidth=100
ignoreTime=true

if [ $# -ge 4 ]; then mapTaskNum=$4; fi
if [ $# -ge 5 ]; then bandWidth=$5; fi

time=`date +%Y%m%d%H%M%S`
dirName=`echo $srcDir | sed 's/\///g'`

mkdir -p diff.$time/raw
./list.sh $dstNamenode $srcDir diff.$time/raw/${dirName}.old
./list.sh $srcNamenode $srcDir diff.$time/raw/${dirName}.new
./diff.sh diff.$time/raw/${dirName}.old diff.$time/raw/${dirName}.new diff.$time/raw/${dirName}.diff.tmp $ignoreTime
shuf diff.$time/raw/${dirName}.diff.tmp > diff.$time/raw/${dirName}.diff

mkdir -p diff.$time/split
./split.sh diff.$time/raw/${dirName}.diff diff.$time/split/$dirName $dirName $mapTaskNum

hdfsRoot=/tmp/distcp/diff.$time
hadoop fs -mkdir -p $hdfsRoot/copylist
hadoop fs -copyFromLocal diff.$time/split/$dirName $hdfsRoot/copylist

hdfsCopyListDir=$hdfsRoot/copylist/$dirName
hdfsResultDir=$hdfsRoot/distcp.result/$dirName
./dist_hdfs_migrate.sh $hdfsCopyListDir $srcNamenode $dstNamenode $dstDir $hdfsResultDir DISTCP $bandWidth
